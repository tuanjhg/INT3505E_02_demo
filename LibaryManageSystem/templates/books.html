{% extends "base.html" %}

{% block title %}All Books - Library Management System{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>📚 Library Books</h1>
        <a href="{{ url_for('web.add_book') }}" class="btn btn-primary">➕ Add New Book</a>
    </div>
</div>

<!-- Search and Filter Form -->
<div class="search-container">
    <form method="GET" class="search-form" id="searchForm">
        <div class="search-field">
            <label>🔍 Search</label>
            <input type="text" name="search" value="{{ request.args.get('search', '') }}" 
                   placeholder="Search by title or author...">
        </div>

        
        <div class="search-field">
            <label>📖 Status</label>
            <select name="available_only">
                <option value="">All Books</option>
                <option value="true" {% if request.args.get('available_only') == 'true' %}selected{% endif %}>Available Only</option>
                <option value="false" {% if request.args.get('available_only') == 'false' %}selected{% endif %}>Borrowed Only</option>
            </select>
        </div>
        
        
        <div class="search-actions">
            <button type="submit" class="btn btn-primary">Search</button>
            <a href="{{ url_for('web.books') }}" class="btn btn-secondary">Clear</a>
        </div>
    </form>
</div>

<!-- Results Info -->
{% if books or request.args %}
<div class="results-info">
    {% if books %}
        <strong>📋 Results:</strong> 
        Showing {{ books|length }} books
        {% if request.args.get('search') or request.args.get('author') or request.args.get('available_only') %}
            (filtered from total)
        {% endif %}
    {% else %}
        <strong>❌ No results found</strong>
        {% if request.args.get('search') or request.args.get('author') or request.args.get('available_only') %}
            for your search criteria. <a href="{{ url_for('web.books') }}">View all books</a>
        {% endif %}
    {% endif %}
    
    <!-- Active Filters -->
    {% set active_filters = [] %}
    {% if request.args.get('search') %}
        {% set _ = active_filters.append(('search', 'Search: ' + request.args.get('search'))) %}
    {% endif %}
    {% if request.args.get('author') %}
        {% set _ = active_filters.append(('author', 'Author: ' + request.args.get('author'))) %}
    {% endif %}
    {% if request.args.get('available_only') == 'true' %}
        {% set _ = active_filters.append(('available_only', 'Status: Available Only')) %}
    {% elif request.args.get('available_only') == 'false' %}
        {% set _ = active_filters.append(('available_only', 'Status: Borrowed Only')) %}
    {% endif %}
    
    {% if active_filters %}
        <div class="filters-active">
            <strong>🏷️ Active filters:</strong>
            {% for key, label in active_filters %}
                <span class="filter-tag">
                    {{ label }}
                    <span class="remove" onclick="removeFilter('{{ key }}')" title="Remove filter">×</span>
                </span>
            {% endfor %}
        </div>
    {% endif %}
</div>
{% endif %}

<!-- Page Size and Pagination Controls -->
{% if books %}
<div class="pagination-container">
    <div class="pagination-info">
        Page {{ page }} of {{ total_pages if total_pages > 0 else 1 }} 
        ({{ books|length }} books shown)
    </div>
    
    <div class="page-size-selector">
        <label>📄 Items per page:</label>
        <select onchange="changePageSize(this.value)">
            <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
        </select>
    </div>
    
    <!-- Pagination Links -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ url_for('web.books', page=page-1, per_page=per_page, **request.args.to_dict(flat=False)|dictsort|list|dict) }}">« Previous</a>
        {% else %}
            <span class="disabled">« Previous</span>
        {% endif %}
        
        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <span class="current">{{ p }}</span>
            {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                <a href="{{ url_for('web.books', page=p, per_page=per_page, **request.args.to_dict(flat=False)|dictsort|list|dict) }}">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if page < total_pages %}
            <a href="{{ url_for('web.books', page=page+1, per_page=per_page, **request.args.to_dict(flat=False)|dictsort|list|dict) }}">Next »</a>
        {% else %}
            <span class="disabled">Next »</span>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Books Table -->
{% if books %}
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>
                    <a href="{{ url_for('web.books', sort_by='title', order=('desc' if request.args.get('sort_by') == 'title' and request.args.get('order') != 'desc' else 'asc'), **request.args.to_dict(flat=False)|dictsort|list|dict) }}" 
                       style="text-decoration: none; color: inherit;">
                        📖 Title
                        {% if request.args.get('sort_by') == 'title' %}
                            {% if request.args.get('order') == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a href="{{ url_for('web.books', sort_by='author', order=('desc' if request.args.get('sort_by') == 'author' and request.args.get('order') != 'desc' else 'asc'), **request.args.to_dict(flat=False)|dictsort|list|dict) }}" 
                       style="text-decoration: none; color: inherit;">
                        👤 Author
                        {% if request.args.get('sort_by') == 'author' %}
                            {% if request.args.get('order') == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>📋 ISBN</th>
                <th>📊 Status</th>
                <th>
                    <a href="{{ url_for('web.books', sort_by='created_at', order=('desc' if request.args.get('sort_by') == 'created_at' and request.args.get('order') != 'desc' else 'asc'), **request.args.to_dict(flat=False)|dictsort|list|dict) }}" 
                       style="text-decoration: none; color: inherit;">
                        📅 Added Date
                        {% if request.args.get('sort_by', 'created_at') == 'created_at' %}
                            {% if request.args.get('order', 'desc') == 'asc' %}↑{% else %}↓{% endif %}
                        {% endif %}
                    </a>
                </th>
                <th>⚡ Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td><strong>{{ book.title }}</strong></td>
                <td>{{ book.author }}</td>
                <td><code>{{ book.isbn }}</code></td>
                <td>
                    {% if book.available %}
                        <span class="status-available">✅ Available</span>
                    {% else %}
                        <span class="status-borrowed">❌ Borrowed</span>
                    {% endif %}
                </td>
                <td>{{ book.created_at.strftime('%Y-%m-%d') }}</td>
                <td>
                    <a href="{{ url_for('web.edit_book', book_id=book.id) }}" class="btn btn-warning">✏️ Edit</a>
                    {% if book.available %}
                        <a href="{{ url_for('web.borrow_book', book_id=book.id) }}" class="btn btn-success">📚 Borrow</a>
                    {% endif %}
                    <a href="{{ url_for('web.delete_book', book_id=book.id) }}" class="btn btn-danger" 
                       onclick="return confirm('Are you sure you want to delete this book?')">🗑️ Delete</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% elif not request.args %}
<div class="card">
    <p style="text-align: center; font-size: 18px; color: #6c757d;">
        📚 No books in the library yet. 
        <a href="{{ url_for('web.add_book') }}" class="btn btn-primary">Add your first book</a>
    </p>
</div>
{% endif %}

<script>
function removeFilter(filterKey) {
    const url = new URL(window.location);
    url.searchParams.delete(filterKey);
    // Reset to page 1 when removing filters
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function changePageSize(newPageSize) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', newPageSize);
    url.searchParams.set('page', '1'); // Reset to page 1
    window.location.href = url.toString();
}

// Auto-submit search form after typing (debounced)
let searchTimeout;
document.querySelector('input[name="search"]').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        document.getElementById('searchForm').submit();
    }, 500);
});
</script>
{% endblock %}